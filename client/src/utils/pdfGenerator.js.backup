/**
 * ===============================================
 * PDF GENERATOR UTILITIES - ICONDENIM
 * ===============================================
 * Tạo các loại PDF theo biểu mẫu chuẩn IconDenim:
 * 1. Phiếu Nhập Kho
 * 2. Hóa Đơn Bán Hàng
 * 3. Xác Nhận Đơn Hàng
 * 4. Biểu Mẫu Phản Hồi Khách Hàng
 */

import { jsPDF } from 'jspdf';
import 'jspdf-autotable';

// ===== FONT CONFIGURATION =====
// Cấu hình font Unicode để hiển thị tiếng Việt
const setupVietnameseFont = (doc) => {
    // jsPDF sử dụng font mặc định hỗ trợ tiếng Việt kém
    // Workaround: Sử dụng font Helvetica và encode UTF-8
    doc.setFont('helvetica');
};

// ===== COMPANY INFO =====
const COMPANY_INFO = {
    name: 'ICONDENIM',
    address: 'Địa chỉ cửa hàng',
    phone: 'Số điện thoại',
    email: 'email@icondenim.com',
    website: 'www.icondenim.com'
};

// ===== HELPER FUNCTIONS =====

/**
 * Format số tiền VND
 */
const formatCurrency = (amount) => {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
};

/**
 * Format ngày tháng Việt Nam
 */
const formatDate = (date) => {
    const d = new Date(date);
    const day = d.getDate().toString().padStart(2, '0');
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
};

/**
 * Thêm header với logo IconDenim
 */
const addHeader = (doc, title, formCode) => {
    const pageWidth = doc.internal.pageSize.width;
    
    // Company name - right aligned
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(COMPANY_INFO.name, pageWidth - 15, 15, { align: 'right' });
    
    // Form info - left aligned
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Don vi:.....................', 15, 15);
    doc.text('Bo phan:.....................', 15, 20);
    
    // Form code - right aligned
    doc.text(`Mau so ${formCode}`, pageWidth - 15, 20, { align: 'right' });
    
    // Title - centered
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title, pageWidth / 2, 35, { align: 'center' });
    
    return 45; // Return Y position after header
};

/**
 * Thêm footer với chữ ký
 */
const addFooter = (doc, yPos, signatories) => {
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    
    // Đảm bảo footer ở cuối trang hoặc sau nội dung
    let footerY = Math.max(yPos + 20, pageHeight - 60);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    
    // Số chữ ký
    const signatureCount = signatories.length;
    const spacing = pageWidth / (signatureCount + 1);
    
    signatories.forEach((sig, index) => {
        const xPos = spacing * (index + 1);
        
        // Tiêu đề chữ ký
        doc.setFont('helvetica', 'bold');
        doc.text(sig.title, xPos, footerY, { align: 'center' });
        
        // Subtitle (nếu có)
        if (sig.subtitle) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text(sig.subtitle, xPos, footerY + 5, { align: 'center' });
        }
        
        // Khoảng trống cho chữ ký
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('(Ky, ghi ro ho ten)', xPos, footerY + 15, { align: 'center' });
    });
};

// ===== PDF GENERATORS =====

/**
 * 1. PHIẾU NHẬP KHO
 * Sử dụng trong Product Management khi nhập hàng
 */
export const generateInventoryImportPDF = (data) => {
    const doc = new jsPDF();
    setupVietnameseFont(doc);
    
    // Header
    let yPos = addHeader(doc, 'PHIEU NHAP KHO', '01 - VT');
    
    // Thông tin phiếu
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    yPos += 10;
    
    const today = new Date();
    const dateStr = `Ngay ..... thang ..... nam ${today.getFullYear()}`;
    doc.text(dateStr, 15, yPos);
    yPos += 7;
    
    doc.text(`So: ${data.importNumber || '............................'}`, 15, yPos);
    const pageWidth = doc.internal.pageSize.width;
    doc.text(`No: ${data.debtorNumber || '..........'}`, pageWidth - 15, yPos - 7, { align: 'right' });
    doc.text(`Co: ${data.creditorNumber || '..........'}`, pageWidth - 15, yPos, { align: 'right' });
    yPos += 7;
    
    doc.text(`- Ho va ten nguoi giao: ${data.deliveryPerson || '............................'}`, 15, yPos);
    yPos += 7;
    
    doc.text(`- Theo ............ so ........... ngay ..... thang ..... nam ..... cua ${data.issuer || '............................'}`, 15, yPos);
    yPos += 7;
    
    doc.text(`Nhap tai kho: ${data.warehouseLocation || '............................da diem'}`, 15, yPos);
    yPos += 10;
    
    // Bảng sản phẩm
    const tableColumns = [
        { header: 'STT', dataKey: 'stt' },
        { header: 'Ten, nhan hieu, quy cach,\nphham chat va chat luong co, sp,\nhang hoa', dataKey: 'description' },
        { header: 'Ma so', dataKey: 'code' },
        { header: 'DVT', dataKey: 'unit' },
        { header: 'So luong\n\nTheo chung tu', dataKey: 'qty_doc' },
        { header: '\n\nThuc nhap', dataKey: 'qty_actual' },
        { header: 'Don gia', dataKey: 'price' },
        { header: 'Thanh tien', dataKey: 'total' }
    ];
    
    const tableData = data.items.map((item, index) => ({
        stt: index + 1,
        description: item.productName,
        code: item.productCode || '',
        unit: item.unit || 'Cai',
        qty_doc: item.quantity,
        qty_actual: item.actualQuantity || item.quantity,
        price: formatCurrency(item.price),
        total: formatCurrency(item.total)
    }));
    
    // Thêm dòng tổng cộng
    tableData.push({
        stt: '',
        description: 'Cong',
        code: 'x',
        unit: 'x',
        qty_doc: 'x',
        qty_actual: 'x',
        price: 'x',
        total: ''
    });
    
    doc.autoTable({
        startY: yPos,
        head: [tableColumns.map(col => col.header)],
        body: tableData.map(row => tableColumns.map(col => row[col.dataKey])),
        theme: 'grid',
        styles: {
            font: 'helvetica',
            fontSize: 9,
            cellPadding: 2,
            halign: 'center',
            valign: 'middle'
        },
        headStyles: {
            fillColor: [255, 255, 255],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        bodyStyles: {
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        columnStyles: {
            0: { cellWidth: 15 }, // STT
            1: { cellWidth: 50, halign: 'left' }, // Tên
            2: { cellWidth: 20 }, // Mã số
            3: { cellWidth: 15 }, // ĐVT
            4: { cellWidth: 20 }, // Số lượng doc
            5: { cellWidth: 20 }, // Thực nhập
            6: { cellWidth: 25 }, // Đơn giá
            7: { cellWidth: 25 } // Thành tiền
        }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // Thông tin thêm
    doc.text(`- Tong so tien (viet bang chu): ${data.totalInWords || '............................'}`, 15, yPos);
    yPos += 7;
    doc.text(`- So chung tu goc kem theo: ${data.attachedDocuments || '............................'}`, 15, yPos);
    yPos += 15;
    
    // Footer với chữ ký
    addFooter(doc, yPos, [
        { title: 'Nguoi lap phieu', subtitle: '(Ky, ho ten)' },
        { title: 'Nguoi giao hang', subtitle: '(Ky, ho ten)' },
        { title: 'Thu kho', subtitle: '(Ky, ho ten)' },
        { title: 'Ke toan truong', subtitle: '(Hoac bo phan co nhu cau nhap)', subtitle2: '(Ky, ho ten)' }
    ]);
    
    // Lưu file
    const fileName = `PhieuNhapKho_${data.importNumber || Date.now()}.pdf`;
    doc.save(fileName);
    
    return fileName;
};

/**
 * 2. HÓA ĐƠN BÁN HÀNG
 * Sử dụng trong Order Management
 */
export const generateSalesInvoicePDF = (orderData) => {
    const doc = new jsPDF();
    setupVietnameseFont(doc);
    
    // Header
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    const pageWidth = doc.internal.pageSize.width;
    doc.text(COMPANY_INFO.name, pageWidth / 2, 20, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Dia chi: ${orderData.shopAddress || COMPANY_INFO.address}`, pageWidth / 2, 27, { align: 'center' });
    doc.text(`DT: ${orderData.shopPhone || COMPANY_INFO.phone}`, pageWidth / 2, 32, { align: 'center' });
    
    // Tiêu đề
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    let yPos = 45;
    doc.text('HOA DON BAN HANG', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    // Thông tin khách hàng
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Ten khach hang: ${orderData.customerName || '............................'}`, 15, yPos);
    yPos += 7;
    doc.text(`Dia chi: ${orderData.customerAddress || '............................'}`, 15, yPos);
    yPos += 10;
    
    // Bảng sản phẩm
    const tableColumns = [
        { header: 'TT', dataKey: 'stt' },
        { header: 'TEN HANG', dataKey: 'productName' },
        { header: 'SO LUONG', dataKey: 'quantity' },
        { header: 'DON GIA', dataKey: 'price' },
        { header: 'THANH TIEN', dataKey: 'total' }
    ];
    
    const tableData = orderData.items.map((item, index) => ({
        stt: index + 1,
        productName: `${item.productName}\n${item.color ? `Mau: ${item.color}` : ''} ${item.size ? `Size: ${item.size}` : ''}`,
        quantity: item.quantity,
        price: formatCurrency(item.price),
        total: formatCurrency(item.price * item.quantity)
    }));
    
    // Dòng tổng cộng
    const totalAmount = orderData.totalPrice || orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    tableData.push({
        stt: '',
        productName: 'TONG CONG',
        quantity: '',
        price: '',
        total: formatCurrency(totalAmount)
    });
    
    doc.autoTable({
        startY: yPos,
        head: [tableColumns.map(col => col.header)],
        body: tableData.map(row => tableColumns.map(col => row[col.dataKey])),
        theme: 'grid',
        styles: {
            font: 'helvetica',
            fontSize: 10,
            cellPadding: 3,
            halign: 'center',
            valign: 'middle'
        },
        headStyles: {
            fillColor: [255, 255, 255],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        bodyStyles: {
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        columnStyles: {
            0: { cellWidth: 15 }, // TT
            1: { cellWidth: 80, halign: 'left' }, // Tên hàng
            2: { cellWidth: 25 }, // Số lượng
            3: { cellWidth: 30 }, // Đơn giá
            4: { cellWidth: 35 } // Thành tiền
        }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // Tổng tiền
    doc.setFont('helvetica', 'italic');
    doc.text(`Thanh tien (viet bang chu): ${orderData.totalInWords || '............................'}`, 15, yPos);
    yPos += 10;
    
    // Chữ ký
    const today = new Date();
    const dateStr = `Ngay ${today.getDate()} thang ${today.getMonth() + 1} nam ${today.getFullYear()}`;
    doc.text(dateStr, pageWidth - 15, yPos, { align: 'right' });
    yPos += 7;
    
    addFooter(doc, yPos, [
        { title: 'KHACH HANG', subtitle: '' },
        { title: 'NGUOI BAN HANG', subtitle: '' }
    ]);
    
    // Lưu file
    const fileName = `HoaDon_${orderData.orderID || Date.now()}.pdf`;
    doc.save(fileName);
    
    return fileName;
};

/**
 * 2B. HÓA ĐƠN BÁN HÀNG THEO NGÀY
 * Xuất tất cả đơn hàng trong 1 ngày
 */
export const generateDailyInvoicePDF = (dailyData) => {
    const doc = new jsPDF();
    setupVietnameseFont(doc);
    
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    
    // Header
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(COMPANY_INFO.name, pageWidth / 2, 20, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Dia chi: ${dailyData.shopAddress || COMPANY_INFO.address}`, pageWidth / 2, 27, { align: 'center' });
    doc.text(`DT: ${dailyData.shopPhone || COMPANY_INFO.phone}`, pageWidth / 2, 32, { align: 'center' });
    
    // Tiêu đề
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    let yPos = 45;
    doc.text('HOA DON BAN HANG', pageWidth / 2, yPos, { align: 'center' });
    yPos += 7;
    
    // Ngày xuất hóa đơn
    const invoiceDate = new Date(dailyData.date);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Ngay: ${invoiceDate.getDate()}/${invoiceDate.getMonth() + 1}/${invoiceDate.getFullYear()}`, pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    // Tổng hợp theo từng đơn hàng
    let grandTotal = 0;
    let orderCount = 0;
    
    dailyData.orders.forEach((orderData, orderIndex) => {
        // Kiểm tra xem có đủ không gian không, nếu không thì thêm trang mới
        if (yPos > pageHeight - 80) {
            doc.addPage();
            yPos = 20;
        }
        
        orderCount++;
        
        // Thông tin đơn hàng
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text(`Don hang #${orderData.orderID}`, 15, yPos);
        yPos += 7;
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text(`Khach hang: ${orderData.customerName || 'N/A'}`, 15, yPos);
        yPos += 5;
        doc.text(`Dia chi: ${orderData.customerAddress || 'N/A'}`, 15, yPos);
        yPos += 7;
        
        // Bảng sản phẩm cho đơn hàng này
        const tableColumns = [
            { header: 'TT', dataKey: 'stt' },
            { header: 'TEN HANG', dataKey: 'productName' },
            { header: 'SL', dataKey: 'quantity' },
            { header: 'DON GIA', dataKey: 'price' },
            { header: 'THANH TIEN', dataKey: 'total' }
        ];
        
        const tableData = orderData.items.map((item, index) => ({
            stt: index + 1,
            productName: `${item.productName}${item.color ? ` - ${item.color}` : ''}${item.size ? ` (${item.size})` : ''}`,
            quantity: item.quantity,
            price: formatCurrency(item.price),
            total: formatCurrency(item.price * item.quantity)
        }));
        
        // Tính tổng đơn hàng
        const orderTotal = orderData.totalPrice || orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        grandTotal += orderTotal;
        
        tableData.push({
            stt: '',
            productName: 'Tong don',
            quantity: '',
            price: '',
            total: formatCurrency(orderTotal)
        });
        
        doc.autoTable({
            startY: yPos,
            head: [tableColumns.map(col => col.header)],
            body: tableData.map(row => tableColumns.map(col => row[col.dataKey])),
            theme: 'grid',
            styles: {
                font: 'helvetica',
                fontSize: 8,
                cellPadding: 2,
                halign: 'center',
                valign: 'middle'
            },
            headStyles: {
                fillColor: [240, 240, 240],
                textColor: [0, 0, 0],
                fontStyle: 'bold',
                lineWidth: 0.3,
                lineColor: [0, 0, 0]
            },
            bodyStyles: {
                lineWidth: 0.3,
                lineColor: [0, 0, 0]
            },
            columnStyles: {
                0: { cellWidth: 12 },
                1: { cellWidth: 85, halign: 'left' },
                2: { cellWidth: 15 },
                3: { cellWidth: 35 },
                4: { cellWidth: 38 }
            }
        });
        
        yPos = doc.lastAutoTable.finalY + 8;
    });
    
    // Tổng kết cuối ngày
    if (yPos > pageHeight - 50) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.line(15, yPos, pageWidth - 15, yPos);
    yPos += 8;
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('TONG KET NGAY:', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Tong so don hang: ${orderCount}`, 15, yPos);
    yPos += 6;
    doc.text(`Tong doanh thu: ${formatCurrency(grandTotal)}`, 15, yPos);
    yPos += 10;
    
    // Chữ ký
    const today = new Date();
    const dateStr = `Ngay ${today.getDate()} thang ${today.getMonth() + 1} nam ${today.getFullYear()}`;
    doc.text(dateStr, pageWidth - 15, yPos, { align: 'right' });
    yPos += 10;
    
    addFooter(doc, yPos, [
        { title: 'NGUOI LAP', subtitle: '(Ky, ghi ro ho ten)' },
        { title: 'KE TOAN', subtitle: '(Ky, ghi ro ho ten)' },
        { title: 'GIAM DOC', subtitle: '(Ky, ghi ro ho ten)' }
    ]);
    
    // Lưu file
    const fileName = `HoaDon_Ngay_${invoiceDate.getDate()}-${invoiceDate.getMonth() + 1}-${invoiceDate.getFullYear()}.pdf`;
    doc.save(fileName);
    
    return fileName;
};

/**
 * 3. XÁC NHẬN ĐƠN HÀNG
 * Sử dụng trong Order Management
 */
export const generateOrderConfirmationPDF = (orderData) => {
    const doc = new jsPDF();
    setupVietnameseFont(doc);
    
    // Header
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    const pageWidth = doc.internal.pageSize.width;
    doc.text(COMPANY_INFO.name, pageWidth / 2, 20, { align: 'center' });
    
    // Tiêu đề
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    let yPos = 35;
    doc.text('XAC NHAN DON HANG', pageWidth / 2, yPos, { align: 'center' });
    yPos += 15;
    
    // Thông tin đơn hàng
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Ma don hang: ${orderData.orderID || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`Ben Ban: Icondenim`, 15, yPos);
    yPos += 7;
    doc.text(`Ma so thue: ${orderData.taxCode || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`Ngay xuat don: ${formatDate(orderData.createdAt || new Date())}`, 15, yPos);
    yPos += 7;
    doc.text(`Ngay nhan hang: 7 ngay lam viec ke tu ngay bat mua dat coc`, 15, yPos);
    yPos += 7;
    doc.text(`Dia chi giao hang: ${orderData.address || ''}`, 15, yPos);
    yPos += 10;
    
    // Bảng sản phẩm
    const tableColumns = [
        { header: 'STT', dataKey: 'stt' },
        { header: 'San pham', dataKey: 'product' },
        { header: 'DVT', dataKey: 'unit' },
        { header: 'So luong', dataKey: 'quantity' },
        { header: 'Don gia(chua VAT) (dong)', dataKey: 'price' },
        { header: 'Thanh tien (dong)', dataKey: 'total' }
    ];
    
    const tableData = orderData.items.map((item, index) => ({
        stt: index + 1,
        product: `${item.productName}\n${item.color || ''} ${item.size || ''}`,
        unit: 'Cai',
        quantity: item.quantity,
        price: formatCurrency(item.price),
        total: formatCurrency(item.price * item.quantity)
    }));
    
    doc.autoTable({
        startY: yPos,
        head: [tableColumns.map(col => col.header)],
        body: tableData.map(row => tableColumns.map(col => row[col.dataKey])),
        theme: 'grid',
        styles: {
            font: 'helvetica',
            fontSize: 9,
            cellPadding: 3,
            halign: 'center',
            valign: 'middle'
        },
        headStyles: {
            fillColor: [255, 255, 255],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        bodyStyles: {
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
        },
        columnStyles: {
            0: { cellWidth: 15 }, // STT
            1: { cellWidth: 60, halign: 'left' }, // Sản phẩm
            2: { cellWidth: 20 }, // ĐVT
            3: { cellWidth: 20 }, // Số lượng
            4: { cellWidth: 35 }, // Đơn giá
            5: { cellWidth: 35 } // Thành tiền
        }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // Thông tin thanh toán
    doc.text(`VAT (10%)`, 15, yPos);
    yPos += 5;
    doc.text(`Tong tien`, 15, yPos);
    yPos += 5;
    doc.text(`Dat coc`, 15, yPos);
    yPos += 5;
    doc.text(`Thanh toan khi giao hang`, 15, yPos);
    yPos += 15;
    
    // Chữ ký
    addFooter(doc, yPos, [
        { title: 'BEN BAN', subtitle: '(ky, ghi ro ho ten)' },
        { title: 'BEN MUA', subtitle: '(ky, ghi ro ho ten)' }
    ]);
    
    // Lưu file
    const fileName = `XacNhanDonHang_${orderData.orderID || Date.now()}.pdf`;
    doc.save(fileName);
    
    return fileName;
};

/**
 * 4. BIỂU MẪU PHẢN HỒI KHÁCH HÀNG
 * Sử dụng trong Customer Management
 */
export const generateCustomerFeedbackPDF = (customerData) => {
    const doc = new jsPDF();
    setupVietnameseFont(doc);
    
    // Header với logo
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    const pageWidth = doc.internal.pageSize.width;
    
    let yPos = 20;
    doc.text(COMPANY_INFO.name, pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    // Tiêu đề
    doc.setFontSize(14);
    doc.text('BIEU MAU GHI NHAN PHAN HOI KHACH HANG', pageWidth / 2, yPos, { align: 'center' });
    yPos += 15;
    
    // Phần I: Thông tin khách hàng
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('I. THONG TIN KHACH HANG', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Ho va ten: ${customerData.fullname || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`So dien thoai: ${customerData.phone || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`Email: ${customerData.email || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`Dia chi: ${customerData.address || ''}`, 15, yPos);
    yPos += 7;
    doc.text(`Ngay phan hoi: ${formatDate(customerData.feedbackDate || new Date())}`, 15, yPos);
    yPos += 12;
    
    // Phần II: Nội dung phản hồi
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('II. NOI DUNG PHAN HOI CUA KHACH HANG', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('Noi dung phan hoi:', 15, yPos);
    yPos += 7;
    
    // Box cho nội dung phản hồi
    const boxHeight = 40;
    doc.rect(15, yPos, pageWidth - 30, boxHeight);
    
    // Split feedback text để fit trong box
    if (customerData.feedback) {
        const splitText = doc.splitTextToSize(customerData.feedback, pageWidth - 40);
        doc.text(splitText, 20, yPos + 5);
    }
    
    yPos += boxHeight + 12;
    
    // Phần III: Phương án xử lý
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('III. PHUONG AN XU LY CUA NHAN VIEN/SHOP', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('Phuong an xu ly:', 15, yPos);
    yPos += 7;
    
    // Box cho phương án xử lý
    doc.rect(15, yPos, pageWidth - 30, boxHeight);
    
    if (customerData.resolution) {
        const splitText = doc.splitTextToSize(customerData.resolution, pageWidth - 40);
        doc.text(splitText, 20, yPos + 5);
    }
    
    yPos += boxHeight + 12;
    
    // Phần IV: Đánh giá
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('IV. DANH GIA SAU XU LY CUA KHACH HANG', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('Muc do hai long: Danh X', 15, yPos);
    yPos += 7;
    
    // Rating boxes
    const ratings = ['Rat hai long', 'Hai long', 'Binh thuong', 'Khong hai long'];
    const boxSize = 5;
    const startX = 15;
    const spacing = 45;
    
    ratings.forEach((rating, index) => {
        const xPos = startX + (index * spacing);
        doc.rect(xPos, yPos, boxSize, boxSize); // Checkbox
        doc.text(rating, xPos + boxSize + 3, yPos + 4);
        
        // Đánh dấu nếu có rating
        if (customerData.rating && customerData.rating === rating) {
            doc.text('X', xPos + 1, yPos + 4);
        }
    });
    
    yPos += 15;
    
    // Chữ ký
    addFooter(doc, yPos, [
        { title: 'Nguoi ghi nhan', subtitle: '(Ky, ghi ro ho ten)' },
        { title: 'Khach hang', subtitle: '(Ky, ghi ro ho ten)' }
    ]);
    
    // Lưu file
    const fileName = `PhanHoiKhachHang_${customerData.userID || Date.now()}.pdf`;
    doc.save(fileName);
    
    return fileName;
};

/**
 * ===== EXPORT ALL FUNCTIONS =====
 */
export default {
    generateInventoryImportPDF,
    generateSalesInvoicePDF,
    generateOrderConfirmationPDF,
    generateCustomerFeedbackPDF,
    formatCurrency,
    formatDate
};
